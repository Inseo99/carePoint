<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 상세정보 입력</title>
    <link href="/css/user/detail.css" type="text/css" rel="stylesheet">
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<main class="container">
    <h1 class="title">상세정보 입력</h1>
    <form class="form">
        <div class="input-group">
            <label for="age">나이를 알려주세요</label>
            <div class="inline-input">
                <input type="text" id="age" placeholder="">
                <span> 세</span>
            </div>
        </div>

        <div class="input-group">
            <label for="height">키를 알려주세요</label>
            <div class="inline-input">
                <input type="text" id="height" placeholder="">
                <span>cm</span>
            </div>
        </div>

        <div class="input-group">
            <label for="weight">체중을 알려주세요</label>
            <div class="inline-input">
                <input type="text" id="weight" placeholder="">
                <span>kg</span>
            </div>
        </div>

        <div class="input-group">
            <label for="disease-type">질병의 종류</label>
            <select id="disease-type">
                <option value="" selected>선택해주세요</option>
                <option value="당뇨">당뇨</option>
                <option value="비만">비만</option>
                <option value="고혈압">고혈압</option>
            </select>
        </div>

        <div class="input-group">
            <label for="disease-level">질병의 정도</label>
            <select id="disease-level">
                <option value="" selected>선택해주세요</option>
                <option value="경도">경도</option>
                <option value="중도">중도</option>
                <option value="고도">고도</option>
            </select>
        </div>

        <div class="input-group">
            <label for="exercise-frequency">주 몇회 정도 운동하시나요?</label>
            <select id="exercise-frequency">
                <option value="" selected>선택해주세요</option>
                <option value="운동안함">운동안함</option>
                <option value="1~2회">주 1회 ~ 2회</option>
                <option value="2~3회">주 2 ~ 3회</option>
                <option value="4~5회">주 4 ~ 5회</option>
                <option value="6회 이상">주 6회 이상</option>
            </select>
        </div>

        <div class="input-group radio-group">
            <label>성별을 알려주세요</label>
            <div class="aa">
                <button type="button" class="radio-btn active" data-value="M">남성</button>
                <button type="button" class="radio-btn" data-value="F">여성</button>
            </div>
            <input type="hidden" name="gender" id="gender" value="M">
        </div>

        <div class="input-group radio-group">
            <label>흡연 하시나요?</label>
            <div class="aa">
                <button type="button" class="radio-btn active" data-value="0">비흡연</button>
                <button type="button" class="radio-btn" data-value="1">흡연</button>
            </div>
            <input type="hidden" name="smoking" id="smoking" value="0">
        </div>

        <div class="input-group radio-group">
            <label>음주 하시나요?</label>
            <div class="aa">
                <button type="button" class="radio-btn active" data-value="0">음주안함</button>
                <button type="button" class="radio-btn" data-value="1">음주</button>
            </div>
            <input type="hidden" name="drinking" id="drinking" value="0">
        </div>




        <button type="submit" class="submit-btn">상세정보 입력 완료</button>
    </form>

</main>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>
<script>

    document.addEventListener("DOMContentLoaded", function () {
        // 🚀 흡연 & 음주 버튼 클릭 시 hidden input 값 변경
        document.querySelectorAll(".radio-group").forEach(group => {
            const buttons = group.querySelectorAll(".radio-btn");
            const hiddenInput = group.querySelector("input[type='hidden']"); // 해당 그룹의 hidden input 가져오기

            buttons.forEach(button => {
                button.addEventListener("click", function () {
                    // 같은 그룹의 모든 버튼에서 active 제거
                    buttons.forEach(btn => btn.classList.remove("active"));

                    // 클릭한 버튼에 active 추가
                    this.classList.add("active");

                    // 🚀 선택된 버튼의 값(hidden input) 설정 (data-value 사용)
                    hiddenInput.value = this.getAttribute("data-value");
                    console.log(`✅ ${hiddenInput.name} 값 변경:`, hiddenInput.value);
                });
            });
        });

        // 🚀 userPk 가져오기
        fetch("/user/getUserPk", {
            method: "GET",
            credentials: "include" // ✅ 세션 유지 (중요!)
        })
            .then(response => response.json())
            .then(data => {
                if (data.userPk) {
                    console.log("✅ userPk 가져오기 성공:", data.userPk);

                    // 🚀 폼 제출 이벤트
                    document.querySelector(".form").addEventListener("submit", function (event) {
                        event.preventDefault(); // 기본 제출 방지

                        const smokingInput = document.getElementById("smoking");
                        const drinkingInput = document.getElementById("drinking");
                        const genderInput = document.getElementById("gender");

                        console.log("📢 smoking 값:", smokingInput.value);
                        console.log("📢 drinking 값:", drinkingInput.value);
                        console.log("📢 gender 값:", genderInput.value);

                        const userData = {
                            age: parseInt(document.getElementById("age").value),
                            weight: document.getElementById("weight").value.trim(),
                            height: document.getElementById("height").value.trim(),
                            gender: genderInput.value.trim(), //  gender 값 추가
                            sickType: document.getElementById("disease-type").value,
                            sickDetail: document.getElementById("disease-level").value,
                            exerciseCnt: document.getElementById("exercise-frequency").value,
                            smoke: parseInt(smokingInput.value) || 0, // 🚀 NaN 방지
                            drink: parseInt(drinkingInput.value) || 0, // 🚀 NaN 방지
                            targetCount: 0,
                            userPk: data.userPk // ✅ 세션에서 가져온 userPk 사용
                        };

                        console.log("📢 서버로 보낼 데이터:", userData);

                        fetch("/user/doInsertDetail", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(userData)
                        })
                            .then(response => response.json())
                            .then(data => {
                                console.log("✅ 서버 응답:", data);
                                if (data.status === "success") {
                                    alert(data.message);
                                    window.location.href = "/user/mainPage";
                                } else {
                                    alert("저장 실패: " + data.message);
                                }
                            })
                            .catch(error => {
                                console.error("🚨 서버 요청 오류:", error);
                            });
                    });
                } else {
                    console.error("🚨 userPk 없음: 로그인 필요");
                }
            })
            .catch(error => {
                console.error("🚨 API 호출 오류:", error);
            });
    });


</script>



</body>
</html>
