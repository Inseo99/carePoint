<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <title>AI 추천 식단</title>
    <link rel="stylesheet" href="/css/food/recomResult.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div id="loading" style="display: none;">
    <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
        <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
    </svg>
    <p>AI가 식단을 추천 중입니다...</p>
</div>



<div class="wrapper">
    <h1 id="goal-title">AI가 추천하는 3가지 식단</h1>

    <!-- 탭 (2, 3은 처음에 숨김) -->
    <div class="tabs">
        <div class="tab active" data-tab="tab1">식단 1 🍴</div>
        <div class="tab" data-tab="tab2" style="display: none;">식단 2 🍴</div>
        <div class="tab" data-tab="tab3" style="display: none;">식단 3 🍴</div>
    </div>

    <!-- 식단1 표 -->
    <div id="tab1" class="tab-content active">
        <table>
            <thead>
            <tr>
                <th>메뉴</th>
                <th>영양정보</th>
            </tr>
            </thead>
            <tbody>
            <!-- 아침 -->
            <tr>
                <td>아침 식단 😊<br><ul id="tab1-breakfast"></ul></td>
                <td><ul id="tab1-breakfast-nutrition"></ul><p id="tab1-breakfast-tip"></p></td>
            </tr>
            <!-- 점심 -->
            <tr>
                <td>점심 식단 ✨<br><ul id="tab1-lunch"></ul></td>
                <td><ul id="tab1-lunch-nutrition"></ul><p id="tab1-lunch-tip"></p></td>
            </tr>
            <!-- 저녁 -->
            <tr>
                <td>저녁 식단 🌙<br><ul id="tab1-dinner"></ul></td>
                <td><ul id="tab1-dinner-nutrition"></ul><p id="tab1-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 식단2 표 -->
    <div id="tab2" class="tab-content">
        <table>
            <thead>
            <tr>
                <th>메뉴</th>
                <th>영양정보</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>아침 식단 😊<br><ul id="tab2-breakfast"></ul></td>
                <td><ul id="tab2-breakfast-nutrition"></ul><p id="tab2-breakfast-tip"></p></td>
            </tr>
            <tr>
                <td>점심 식단 ✨<br><ul id="tab2-lunch"></ul></td>
                <td><ul id="tab2-lunch-nutrition"></ul><p id="tab2-lunch-tip"></p></td>
            </tr>
            <tr>
                <td>저녁 식단 🌙<br><ul id="tab2-dinner"></ul></td>
                <td><ul id="tab2-dinner-nutrition"></ul><p id="tab2-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 식단3 표 -->
    <div id="tab3" class="tab-content">
        <table>
            <thead>
            <tr>
                <th>메뉴</th>
                <th>영양정보</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>아침 식단 😊<br><ul id="tab3-breakfast"></ul></td>
                <td><ul id="tab3-breakfast-nutrition"></ul><p id="tab3-breakfast-tip"></p></td>
            </tr>
            <tr>
                <td>점심 식단 ✨<br><ul id="tab3-lunch"></ul></td>
                <td><ul id="tab3-lunch-nutrition"></ul><p id="tab3-lunch-tip"></p></td>
            </tr>
            <tr>
                <td>저녁 식단 🌙<br><ul id="tab3-dinner"></ul></td>
                <td><ul id="tab3-dinner-nutrition"></ul><p id="tab3-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 버튼 -->
    <div class="buttons">
        <button class="button" onclick="window.location.href='/food/recom'">다른 목표 선택</button>
        <button class="button" onclick="window.location.href='/user/mainPage'">메인화면</button>
        <button class="button" id="add-diet">식단 추가</button>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
    // 식단 텍스트를 파싱하는 함수
    function parseMealOption(text) {
        const lines = text.split("\n").map(line => line.trim());
        let currentSection = null;

        const data = {
            breakfast: [],
            breakfastNutrition: [],
            breakfastTip: [],
            lunch: [],
            lunchNutrition: [],
            lunchTip: [],
            dinner: [],
            dinnerNutrition: [],
            dinnerTip: []
        };

        for (let line of lines) {
            // "### 식단 1:" 등의 헤더는 건너뛰기
            if (line.startsWith("### ")) {
                continue;
            }
            if (line.startsWith("**아침**")) {
                currentSection = "breakfast";
                continue;
            } else if (line.startsWith("**아침 영양 정보**")) {
                currentSection = "breakfastNutrition";
                continue;
            } else if (line.startsWith("**아침 영양 팁**")) {
                currentSection = "breakfastTip";
                continue;
            } else if (line.startsWith("**점심**")) {
                currentSection = "lunch";
                continue;
            } else if (line.startsWith("**점심 영양 정보**")) {
                currentSection = "lunchNutrition";
                continue;
            } else if (line.startsWith("**점심 영양 팁**")) {
                currentSection = "lunchTip";
                continue;
            } else if (line.startsWith("**저녁**")) {
                currentSection = "dinner";
                continue;
            } else if (line.startsWith("**저녁 영양 정보**")) {
                currentSection = "dinnerNutrition";
                continue;
            } else if (line.startsWith("**저녁 영양 팁**")) {
                currentSection = "dinnerTip";
                continue;
            }

            if (line.startsWith("-")) {
                const item = line.replace(/^-\s*/, "");
                if (currentSection && data[currentSection]) {
                    data[currentSection].push(item);
                }
            }
        }
        return data;
    }

    // 파싱된 데이터를 HTML의 해당 위치에 렌더링하는 함수
    function renderDietToHTML(dietData, tabIndex) {
        // 아침
        $(`#tab${tabIndex}-breakfast`).empty().append(
            dietData.breakfast.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-breakfast-nutrition`).empty().append(
            dietData.breakfastNutrition.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-breakfast-tip`).text(dietData.breakfastTip.join(" "));

        // 점심
        $(`#tab${tabIndex}-lunch`).empty().append(
            dietData.lunch.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-lunch-nutrition`).empty().append(
            dietData.lunchNutrition.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-lunch-tip`).text(dietData.lunchTip.join(" "));

        // 저녁
        $(`#tab${tabIndex}-dinner`).empty().append(
            dietData.dinner.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-dinner-nutrition`).empty().append(
            dietData.dinnerNutrition.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-dinner-tip`).text(dietData.dinnerTip.join(" "));
    }

    // 탭 활성화 함수
    function activateTab(tabId) {
        $(".tab").removeClass("active");
        $(".tab-content").removeClass("active").hide();
        $(`.tab[data-tab="${tabId}"]`).addClass("active");
        $(`#${tabId}`).addClass("active").show();
    }

    // AJAX 요청으로 새로운 식단을 가져오는 함수
    function fetchNewDiet(tabIndex) {
        const goal = localStorage.getItem("goal");
        if (!goal) {
            alert("추천받은 식단이 없습니다. 다시 추천을 받아주세요.");
            window.location.href = "/food/recom";
            return;
        }
        $("#loading").show();
        $.ajax({
            url: "http://localhost:8000/recommend",
            type: "GET",
            data: { goal: goal },
            success: function(response) {
                $("#loading").hide();
                const mealOption = response.meal_options;
                if (mealOption) {
                    const dietData = parseMealOption(mealOption);
                    renderDietToHTML(dietData, tabIndex);
                    // 새 탭 활성화
                    activateTab("tab" + tabIndex);
                } else {
                    alert("추천된 식단이 없습니다.");
                }
            },
            error: function() {
                $("#loading").hide();
                alert("추천을 가져오는 데 실패했습니다.");
            }
        });
    }

    $(document).ready(function(){
        $("#loading").show();

        const goal = localStorage.getItem("goal");
        if (!goal) {
            alert("추천받은 식단이 없습니다. 다시 추천을 받아주세요.");
            window.location.href = "/food/recom";
            return;
        }
        $("#goal-title").text(`${goal}를 위한 AI 추천 식단`);

        // 초기 식단(식단1) 요청 및 렌더링
        $.ajax({
            url: "http://localhost:8000/recommend",
            type: "GET",
            data: { goal: goal },
            success: function(response) {
                $("#loading").hide();
                const mealOption = response.meal_options;
                if (mealOption) {
                    const dietData = parseMealOption(mealOption);
                    renderDietToHTML(dietData, 1);
                    activateTab("tab1");
                } else {
                    alert("추천된 식단이 없습니다.");
                }
            },
            error: function() {
                $("#loading").hide();
                alert("추천을 가져오는 데 실패했습니다.");
            }
        });

        // 탭 클릭 이벤트 (각 탭을 클릭하면 해당 탭 내용이 보이도록)
        $(".tab").click(function(){
            const tabId = $(this).attr("data-tab");
            activateTab(tabId);
        });

        // '식단 추가' 버튼 클릭 이벤트
        $("#add-diet").click(function(){
            if(confirm("식단을 추가하시겠습니까?")) {
                let nextTabIndex;
                if ($("#tab2").is(":hidden")) {
                    nextTabIndex = 2;
                    $(`.tab[data-tab="tab2"]`).show();
                } else if ($("#tab3").is(":hidden")) {
                    nextTabIndex = 3;
                    $(`.tab[data-tab="tab3"]`).show();
                } else {
                    alert("더 이상 추가할 수 없습니다.");
                    return;
                }
                fetchNewDiet(nextTabIndex);
            }
        });
    });
</script>

</body>
</html>
