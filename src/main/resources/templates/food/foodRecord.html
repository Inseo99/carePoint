<!DOCTYPE html>
<html lang="UTF-8">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>식단 기록</title>
  <link rel="stylesheet" href="/css/food/foodRecord.css">
  <!-- 제이쿼리 불러오기 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div class="container">
  <!-- 상단 탭 -->
  <div class="tabs">
    <a href="/food/foodRecord" class="tab-button active">기록</a>
    <a href="/food/foodList" class="tab-button">목록</a>
    <a href="/food/analysis" class="tab-button">내 식단 분석</a>
  </div>

  <!-- 외곽 박스 -->
  <div class="outer-container">
    <div class="content-wrapper">
      <div class="card morning">
        <button class="plus-button">+</button>
        <div class="icon"><img src="/images/아침.png" alt="아침"></div>
        <div class="title">아침</div>
      </div>
      <div class="card lunch">
        <button class="plus-button">+</button>
        <div class="icon"><img src="/images/점심.png" alt="점심"></div>
        <div class="title">점심</div>
      </div>
      <div class="card dinner">
        <button class="plus-button">+</button>
        <div class="icon"><img src="/images/저녁.png" alt="저녁"></div>
        <div class="title">저녁</div>
      </div>
      <div class="card idea">
        <div class="icon idea"><img src="/images/전구.png" alt="전구"></div>
        <p class="description">
          Lorem ipsum dolor sit amet consectetur adipisicing elit.
        </p>
      </div>
    </div>
  </div>
</div>


<div class="popup-overlay">
  <div class="popup1">
    <!-- 상단에 닫기 버튼 추가 -->
    <button class="popup-close-btn">x</button>
    <div class="search-section">
      <input type="text" class="search-bar" placeholder="무슨 음식을 드셨나요?">
      <button class="search-button">검색</button>
    </div>
    <div class="search-results">
      <table>
        <thead>
        <tr>
          <th>음식명</th>
          <th>칼로리</th>
          <th>영양정보</th>
        </tr>
        </thead>
        <tbody>
        <!-- 검색 결과가 여기에 추가될 예정 -->
        </tbody>
      </table>
    </div>
    <div class="selected-menu">
      <img src="/images/연필.png" alt="연필 아이콘" class="large-pencil-icon">
      <ul>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </div>
    <button class="record-button">기록하기</button>
  </div>
</div>


<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
  $(document).ready(function () {
    let activeSlot = null; // 현재 활성화된 슬롯
    let selectedFoodType = ""; // 현재 선택된 식사 타입 (아침, 점심, 저녁)

    // 팝업 열기 + 식사 타입 설정
    $('.plus-button').click(function () {
      $('.popup-overlay').fadeIn();
      $('.popup1').fadeIn();

      // 클릭된 카드에서 식사 타입(아침, 점심, 저녁) 가져오기
      let parentCard = $(this).closest(".card");
      selectedFoodType = parentCard.find(".title").text().trim(); // "아침", "점심", "저녁"
    });

    // 팝업 닫기 (오버레이 또는 닫기 버튼 클릭)
    $('.popup-overlay, .popup-close-btn').click(function () {
      $('.popup-overlay').fadeOut();
      $('.popup1').fadeOut();
    });

    // 팝업 내부 클릭 시 닫히지 않도록 방지 (❗ 원래 코드에서 빠졌던 부분 추가)
    $('.popup1').on('click', function (event) {
      event.stopPropagation();
    });

    // 검색 버튼 클릭 시 API 호출
    $(".search-button").click(function () {
      let query = $(".search-bar").val().trim();
      if (query === "") return;

      $.ajax({
        url: "/food/search",
        type: "GET",
        data: { query: query },
        success: function (response) {
          let tableBody = $(".search-results tbody");
          tableBody.empty(); // 기존 검색 결과 초기화

          response.forEach(food => {
            let row = `
                        <tr data-menu="${food.menu}" data-kcal="${food.kcal}"
                            data-protein="${food.protein}" data-carb="${food.carbohydrate}"
                            data-fat="${food.fat}">
                            <td>${food.menu}</td>
                            <td>${food.kcal} kcal</td>
                            <td>단백질: ${food.protein}g | 탄수화물: ${food.carbohydrate}g | 지방: ${food.fat}g</td>
                        </tr>
                    `;
            tableBody.append(row);
          });

          $(".search-results").fadeIn();
        },
        error: function () {
          alert("음식 검색에 실패했습니다.");
        }
      });
    });

    // 검색 결과 클릭 시 선택 메뉴에 추가
    $(".search-results").on("click", "tr", function () {
      let foodName = $(this).data("menu");
      let kcal = $(this).data("kcal");
      let protein = $(this).data("protein");
      let carbohydrate = $(this).data("carb");
      let fat = $(this).data("fat");

      const selectedText = `
            <span>${foodName}</span>
            <span>${kcal} kcal</span>
            <span class="small-text">단백질: ${protein}g | 탄수화물: ${carbohydrate}g | 지방: ${fat}g</span>
        `;

      if (activeSlot) {
        activeSlot.html(selectedText);
        activeSlot = null;
      } else {
        const emptySlot = $(".selected-menu li:empty").first();
        if (emptySlot.length > 0) {
          emptySlot.html(selectedText);
        }
      }
    });

    // 선택된 슬롯 클릭 시 활성화
    $(".selected-menu li").click(function () {
      $(".selected-menu li").removeClass("selected");
      $(this).addClass("selected");
      activeSlot = $(this);
    });

    // 기록하기 버튼 클릭 이벤트
    $(".record-button").click(function () {
      let selectedFoods = [];
      let foodTypeCode = selectedFoodType === "아침" ? "B" : selectedFoodType === "점심" ? "L" : "D"; // B: 아침, L: 점심, D: 저녁

      $(".selected-menu li").each(function () {
        if ($(this).html().trim() !== "") {
          let foodData = {
            menu: $(this).find("span:nth-child(1)").text(),
            kcal: parseInt($(this).find("span:nth-child(2)").text().replace(" kcal", "")),
            protein: parseFloat($(this).find(".small-text").text().match(/단백질: ([0-9.]+)g/)[1]),
            carbohydrate: parseFloat($(this).find(".small-text").text().match(/탄수화물: ([0-9.]+)g/)[1]),
            fat: parseFloat($(this).find(".small-text").text().match(/지방: ([0-9.]+)g/)[1])
          };
          selectedFoods.push(foodData);
        }
      });

      if (selectedFoods.length === 0) {
        alert("선택된 음식이 없습니다.");
        return;
      }

      let requestData = {
        selectDate: new Date().toISOString().split("T")[0], // 현재 날짜
        foodType: foodTypeCode, // 정확한 식사 타입 반영
        userPk: 1, // TODO: 로그인 사용자 ID로 변경
        foodList: selectedFoods
      };

      $.ajax({
        url: "/food/record",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(requestData),
        success: function (response) {
          alert("식단이 성공적으로 저장되었습니다.");
          $(".selected-menu li").empty(); // UI 초기화
        },
        error: function () {
          alert("식단 저장에 실패했습니다.");
        }
      });
    });

  });

</script>

</body>
</html>
