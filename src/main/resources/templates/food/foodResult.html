<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 추천 식단</title>
    <link rel="stylesheet" href="/css/food/foodResult.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div class="wrapper">
    <h1 id="goal-title">AI가 추천하는 3가지 식단</h1>

    <div class="tabs">
        <button class="tab active" data-tab="tab1">식단 1 🍴</button>
        <button class="tab" data-tab="tab2">식단 2 🍴</button>
        <button class="tab" data-tab="tab3">식단 3 🍴</button>
    </div>

    <div class="meal-container">
        <div id="tab1" class="tab-content active"></div>
        <div id="tab2" class="tab-content"></div>
        <div id="tab3" class="tab-content"></div>
    </div>

    <div class="buttons">
        <button class="button" onclick="window.location.href='/food/recom'">다른 목표 선택</button>
        <button class="button" onclick="window.location.href='/'">메인화면</button>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
    $(document).ready(function () {
        const goal = localStorage.getItem("goal");
        if (!goal) {
            alert("추천받은 식단이 없습니다. 다시 추천을 받아주세요.");
            window.location.href = "/food/recom";
            return;
        }

        $.ajax({
            url: "http://localhost:8000/recommend",
            type: "GET",
            data: { goal: goal },
            success: function (response) {
                $("#goal-title").text(`${goal}을 위한 AI 추천 식단`);
                const mealOptions = response.meal_options;
                if (mealOptions.length >= 3) {
                    $("#tab1").html(generateMealCard(mealOptions[0]));
                    $("#tab2").html(generateMealCard(mealOptions[1]));
                    $("#tab3").html(generateMealCard(mealOptions[2]));
                }
            },
            error: function () {
                alert("추천을 가져오는 데 실패했습니다.");
            }
        });

        $('.tab').on('click', function () {
            $('.tab').removeClass('active');
            $(this).addClass('active');
            $('.tab-content').removeClass('active');
            $('#' + $(this).data('tab')).addClass('active');
        });
    });

    function generateMealCard(mealText) {
        if (!mealText || mealText.trim() === "") {
            return "<div class='meal-card'><p>추천된 식단이 없습니다.</p></div>";
        }

        const mealLines = mealText.split("\n");
        let html = "<div class='meal-card'>";
        let currentMeal = "";
        let mealContent = "";

        mealLines.forEach(line => {
            line = line.trim();

            if (line.startsWith("**") && line.endsWith("**")) {
                if (currentMeal !== "") {
                    html += `<div class='meal-section'>
                                <h3>${currentMeal}</h3>
                                <p>${mealContent}</p>
                             </div>`;
                    mealContent = "";
                }
                currentMeal = line.replace(/\*\*/g, "");
            } else if (line.startsWith("-")) {
                const parts = line.replace("-", "").split("-");
                mealContent += `<strong>${parts[0].trim()}</strong>: ${parts[1] ? parts[1].trim() : ""}<br>`;
            } else if (line.startsWith("영양 팁:")) {
                html += `<div class='nutrition-tip'><em>${line}</em></div>`;
            }
        });

        if (currentMeal !== "") {
            html += `<div class='meal-section'>
                        <h3>${currentMeal}</h3>
                        <p>${mealContent}</p>
                     </div>`;
        }

        html += "</div>";
        return html;
    }
</script>
</body>
</html>