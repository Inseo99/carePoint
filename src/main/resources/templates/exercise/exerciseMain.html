<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>운동 페이지</title>
    <link href="/css/exercise/exerciseMain.css" rel="stylesheet">
    <!-- 제이쿼리 불러오기 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script th:if="${msg}">
      alert("[[${msg}]]");
    </script>
    <script>
      $(document).ready(function () {
      // 버튼 클릭 하면 팝업 보여줌
      $('.target-write-btn').click(function () {
        console.log("target-write-btn 들어옴");
        $('.target-popup').css('display', 'flex');
      });

      // 버튼 클릭 하면 팝업 가림
      $('.target-popup-close-btn').click(function () {
        $('.target-popup').css('display', 'none');
      });

      // .popup을 클릭하면 닫히도록 설정
      $(".target-popup").on("click", function () {
        $(this).hide(); // .popup을 숨김
      });

      // .popup-content 내부를 클릭했을 때 이벤트 전파 방지
      $(".target-popup-content").on("click", function (event) {
        event.stopPropagation(); // 부모(.popup)로 이벤트가 전달되지 않도록 방지
      });

      // 버튼 클릭 하면 팝업 보여줌
      $('.exercise-type-popup-btn').click(function () {
        $('.exercise-type-popup').css('display', 'flex');
      });

      // 버튼 클릭 하면 팝업 가림
      $('.exercise-type-popup-close-btn').click(function () {
        $('.exercise-type-popup').css('display', 'none');
      });

      // .popup을 클릭하면 닫히도록 설정
      $(".exercise-type-popup").on("click", function () {
        $(this).hide(); // .popup을 숨김
      });

      // .popup-content 내부를 클릭했을 때 이벤트 전파 방지
      $(".exercise-type-popup-content").on("click", function (event) {
        event.stopPropagation(); // 부모(.popup)로 이벤트가 전달되지 않도록 방지
      });
    });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js"></script>
    <script th:inline="javascript">
      let calendar;
      let calendarEl;

      document.addEventListener('DOMContentLoaded', function() {
        calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridWeek', // 주 단위로 표시
          height: 'auto',
          dayMaxEvents: 3,
          contentHeight: 'auto', // 일정이 많아도 높이 유지
          headerToolbar: {
            left: 'prev',
            center: 'title',
            right: 'next'
          },
          views: {
            dayGridMonth: {
              titleFormat: { year: 'numeric', month: '2-digit' } // YYYY.MM 형식
            },
            dayGridWeek: {
              titleFormat: { year: 'numeric', month: '2-digit'} // YYYY.MM 형식
            }
          },
          dayCellDidMount: function(info) {
            let cell = info.el;
            let existingDateEl = cell.querySelector('.fc-daygrid-day-number');

            if (existingDateEl) {
              existingDateEl.remove(); // 기존 날짜 삭제
            }

            let dateEl = document.createElement('div');
            dateEl.classList.add('fc-daygrid-day-number');
            dateEl.innerText = info.date.getDate();

            dateEl.style.position = 'absolute';
            dateEl.style.top = '8px';
            dateEl.style.right = '8px';
            dateEl.style.fontSize = '14px';
            dateEl.style.fontWeight = 'bold';
            dateEl.style.zIndex = '10';

            // 요일에 따라 색상 변경 (일요일: 빨강, 토요일: 파랑)
            let dayOfWeek = info.date.getDay(); // 0: 일요일, 6: 토요일
            if (dayOfWeek === 0) {
              dateEl.style.color = 'red';
            } else if (dayOfWeek === 6) {
              dateEl.style.color = 'blue';
            } else {
              dateEl.style.color = 'black';
            }

            cell.appendChild(dateEl);
          },
          dayHeaderFormat: { weekday: 'short' }, // 요일만 표시
          datesSet: function(info) {
            // FullCalendar가 계산한 타이틀 문자열
            const rawTitle = info.view.title; // 예: "2025/02"

            // 여기서 직접 split 처리
            const parts = rawTitle.split('/');
            let year = 'Unknown Year';
            let month = 'Unknown Month';

            if (parts.length === 2) {
              year = parts[1].trim();
              month = parts[0].trim();
            }

            // 그다음 DOM 조작 (titleEl 제거/추가 등)
            const titleEl = document.querySelector('.fc-toolbar-title');
            if (titleEl) {
                        titleEl.innerHTML = `
                            <div class="calendar-title">
                              <div class="calendar-year">${year}</div>
                              <div class="calendar-month">${month}</div>
                            </div>
                          `;
            }
            setTimeout(() => {
              document.querySelectorAll('.fc-daygrid-day').forEach(cell => {
                let existingDateEl = cell.querySelector('.fc-daygrid-day-number');

                // 기존 날짜 요소가 있으면 삭제
                if (existingDateEl) {
                  existingDateEl.remove();
                }

                // 새로운 날짜 요소 생성
                let dateEl = document.createElement('div');
                dateEl.classList.add('fc-daygrid-day-number');

                // 날짜 계산
                let date = new Date(cell.getAttribute('data-date')).getDate();
                dateEl.innerText = date;

                // 날짜 스타일 적용
                dateEl.style.position = 'absolute';
                dateEl.style.top = '8px';
                dateEl.style.right = '8px';
                dateEl.style.fontSize = '14px';
                dateEl.style.color = 'black';
                dateEl.style.fontWeight = 'bold';
                dateEl.style.zIndex = '10';

                // 날짜 요소 추가
                cell.appendChild(dateEl);
              });
            }, 50);
          },
          events: '/exercise/getExerciseEvents',
          eventClick: function (info) {
            showEventPopup(info.event);
            eventSave(info.event);
          }
        });

        // 📌 서버에서 운동 기록 가져와서 캘린더에 추가
        fetch('/exercise/getExerciseEvents')
          .then(response => response.json())
          .then(exerciseList => {
            exerciseList.forEach(exercise => {
              calendar.addEvent({
                title: `${exercise.exerciseName}`,
                start: exercise.regDate,
                extendedProps: { // ✅ 추가 데이터 저장
                  hour: exercise.hour, // 운동 시간
                  minute: exercise.minute, // 운동 시간
                  kcal: exercise.kcal, // 소모 칼로리
                  exercisePk: exercise.exercisePk
                },
                color: "#9EDE9EFF"
              });
            });
          })
          .catch(error => console.error("Error loading exercises:", error));

        calendar.render();
      });

      // 운동 기록하기
      document.addEventListener("DOMContentLoaded", function () {
        const userPk = [[${userPk}]]; // Model에서 가져온 userPk 값
        const exercisePopup = document.querySelector(".exercise-type-popup");
        const exerciseTypeBtn = document.querySelector(".exercise-type-popup-btn");
        const exerciseTypeSaveBtn = document.querySelector(".exercise-type-save-btn");
        const exerciseTypeDisplay = document.querySelector("#selected-exercise");
        const exerciseTimeHour = document.querySelector("#hour");
        const exerciseTimeMinute = document.querySelector("#minute");
        const saveExerciseBtn = document.querySelector(".exercise-save");
        const exerciseSearchInput = document.querySelector("#exercise-search");
        const exerciseResetBtn = document.querySelector("#reset-exercise-btn");
        let selectedExercise = "";
        let selectedMet = 0; // MET 저장 변수
        let exerciseList = []; // 운동 리스트 저장

        // ✅ 오늘 날짜에 운동 데이터가 있는지 확인
        fetch(`/exercise/has-today-exercise?userPk=${userPk}`)
                .then(response => response.json())
                .then(hasData => {
                  if (hasData && saveExerciseBtn) {
                    // disableSaveExerciseButton();
                  }
                })
                .catch(error => console.error("Error checking today's exercise data:", error));

        // 📌 운동명 리스트 가져오기 (API 호출)
        fetch('/exercise/apiList')
                .then(response => response.json())
                .then(data => {
                  exerciseList = data; // 전체 리스트 저장
                  renderExerciseList(""); // 초기 전체 목록 표시
                })
                .catch(error => console.error("Error fetching exercises:", error));

        // 📌 운동 목록을 화면에 렌더링하는 함수
        function renderExerciseList(searchTerm) {
          const exerciseContainer = document.querySelector(".exercise-type-popup__body");
          exerciseContainer.innerHTML = "";

          // 검색어 필터링
          const filteredExercises = exerciseList.filter(exercise =>
            exercise.exerciseName.includes(searchTerm) // 검색어가 포함된 운동만 필터링
          );

          // 필터링된 운동 리스트 표시
          filteredExercises.forEach(exercise => {
            const exerciseDiv = document.createElement("div");
            exerciseDiv.classList.add("exercise-item");
            exerciseDiv.innerHTML =
                    `<div>${exercise.exerciseName}</div>
                     <input type="hidden" value="${exercise.metValue}">`;

            // 클릭 시 선택된 운동 저장
            exerciseDiv.dataset.exerciseName = exercise.exerciseName;
            exerciseDiv.dataset.metValue = exercise.metValue;

            exerciseContainer.appendChild(exerciseDiv);
          });
        }

        // 📌 운동 검색 기능 (입력할 때마다 필터링)
        exerciseSearchInput.addEventListener("input", function () {
          renderExerciseList(this.value.trim());
        });

        // 📌 운동 클릭 시 선택
        document.querySelector(".exercise-type-popup__body").addEventListener("click", function (event) {
          const selectedDiv = event.target.closest(".exercise-item");
          if (!selectedDiv) return;

          selectedExercise = selectedDiv.dataset.exerciseName; // 선택한 운동명
          selectedMet = selectedDiv.dataset.metValue; // 선택한 MET 값
          document.querySelectorAll(".exercise-item").forEach(div => div.classList.remove("selected"));
          selectedDiv.classList.add("selected");
        });

        // 📌 운동 선택 후 저장
        exerciseTypeSaveBtn.addEventListener("click", function () {
          if (!selectedExercise) {
            alert("운동을 선택해주세요!");
            return;
          }

          exerciseTypeBtn.style.display = "none";
          exerciseTypeDisplay.style.display = "block";
          exerciseTypeDisplay.textContent = selectedExercise;

          // 선택한 값 hidden input으로 저장 (서버 전송용)**
          document.querySelector("#selected-exercise-name").value = selectedExercise;
          document.querySelector("#selected-exercise-met").value = selectedMet;

          exercisePopup.style.display = "none";

          // ✅ 운동 종목이 선택되었으므로 리셋 버튼 표시
          exerciseResetBtn.style.display = "flex";
        });

        // 📌 운동 선택 초기화(삭제) 버튼
        document.getElementById("reset-exercise-btn").addEventListener("click", function () {

          // 선택했던 값 초기화
          selectedExercise = null;
          selectedMet = null;

          // 모든 항목의 selected 클래스 제거
          document.querySelectorAll(".exercise-item").forEach(div => div.classList.remove("selected"));

          // 화면에 표시 중인 운동명도 제거
          exerciseTypeBtn.style.display = "block";
          exerciseTypeDisplay.style.display = "none";
          exerciseTypeDisplay.textContent = "";

          // 선택한 값 hidden input으로 저장 (서버 전송용)**
          document.querySelector("#selected-exercise-name").value = selectedExercise;
          document.querySelector("#selected-exercise-met").value = selectedMet;

          // ✅ 다시 리셋 버튼 숨기기
          exerciseResetBtn.style.display = "none";

          console.log("운동 종목 선택이 초기화되었습니다.");
        });

        // 운동 저장 버튼 클릭 시 데이터 전송
        saveExerciseBtn.addEventListener("click", function (event) {
          event.preventDefault();

          if (!selectedExercise) {
            alert("운동을 선택해주세요!");
            return;
          }

          let hour = parseInt(exerciseTimeHour.value, 10);
          let minute = parseInt(exerciseTimeMinute.value, 10);
          let today = new Date().toLocaleDateString("ko-KR").replace(/. /g, "-").replace(".", "");

          let exerciseData = {
            exerciseName: selectedExercise,
            metValue: selectedMet,
            hour: hour,
            minute: minute,
            regDate: today
          };

          fetch('/exercise/saveExercise', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(exerciseData)
          })
          .then(response => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then(result => {
            alert(result.message); // 올바른 JSON 응답 처리

            // ✅ 주간 목표 달성 수 가져오기
            fetch(`/target/count?userPk=${userPk}`)
                    .then(response => response.json())
                    .then(count => {
                      document.getElementById("weekly-goal-count").textContent = `${count}회`;
                    })
                    .catch(error => console.error("Error fetching weekly goal count:", error));

            // 입력 필드 초기화
            exerciseTypeDisplay.textContent = "";
            exerciseTypeDisplay.style.display = "none";
            exerciseTypeBtn.style.display = "inline-block";
            exerciseTimeHour.value = "00";
            exerciseTimeMinute.value = "00";

            // ✅ 스크롤 이동 플래그 저장 (localStorage 사용)
            localStorage.setItem("scrollToCalendar", "true");

            // ✅ 100ms 후 새로고침 실행
            setTimeout(() => {
              window.location.reload();
            }, 100);
          })
          .catch(error => console.error("Error saving exercise:", error));
        });
      });

      window.onload = function () {
        // ✅ 새로고침 후 이동 플래그 확인
        if (localStorage.getItem("scrollToCalendar") === "true") {
          localStorage.removeItem("scrollToCalendar"); // ✅ 플래그 삭제 (한 번만 실행)

          setTimeout(() => {
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
              console.log("📌 캘린더로 스크롤 이동 실행"); // 디버깅 로그
              calendarEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); // ✅ 스크롤 이동
              calendarEl.focus(); // ✅ 포커스 설정 (선택 사항)
            }
          }, 500); // ✅ 1초 후 실행 (렌더링 완료 후 실행되도록 딜레이 추가)
        }
      };

      // ✅ 기록한 운동 팝업 표시 함수
      function showEventPopup(event) {
        const modal = document.getElementById("event-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalContent = document.getElementById("modal-content");

        /// ✅ 선택한 날짜 가져오기 (YYYY-MM-DD 형식)
        const eventDate = event.start.toISOString().split('T')[0];

        // ✅ 추가 데이터 가져오기
        const { minute, hour, kcal } = event.extendedProps;

        modalTitle.innerText = `${eventDate}`;

        // ✅ 운동 상세 정보 표시
        modalContent.innerHTML = `
          <p><strong>운동명:</strong> <span>${event.title}</span></p>
          <p><strong>운동 시간:</strong> <span>${hour}시간 ${minute}분</span></p>
          <p><strong>소모 칼로리:</strong> <span>${kcal} kcal</span></p>
        `;


        modal.style.display = "flex"; // 모달 띄우기
      }

      // ✅ 운동 기록 삭제하기
      function eventSave(event) {
        const exercisePk = event.extendedProps.exercisePk;
        const userPk = [[${userPk}]]; // Model에서 가져온 userPk 값
        if (exercisePk === 0) {
          console.error("Invalid exercise ID");
          return;
        }

        $(".exercise-delete-btn").off("click").on("click", function () {
          const isConfirmed = confirm("정말 삭제하시겠습니까?");
          if (!isConfirmed) {
            console.log("삭제 취소됨");
            return;
          }

          // 운동 기록 삭제 요청
          fetch(`/exercise/deleteExercise?exercisePk=${exercisePk}`)
                  .then(response => response.json())
                  .then(result => {

                    // ✅ 로딩 모달 문구 변경 (운동 삭제 전용 메시지)
                    $("#loading-screen p").text("운동 기록 삭제 중입니다...");
                    $("#loading-screen").fadeIn();

                    setTimeout(() => {
                      fetch(`/target/current-week?userPk=${userPk}`)
                              .then(response => response.json())
                              .then(data => {
                                if (!data) return;

                                // ✅ 4. 목표 데이터 UI 업데이트
                                document.querySelector(".target-1 .current").textContent = `${data.exerciseCount.toLocaleString()}회`;
                                document.querySelector(".target-1 .goal").textContent = `${data.exerciseTarget.toLocaleString()}회`;
                                document.querySelector(".target-2 .current").textContent = `${data.valueCount.toLocaleString()}회`;
                                document.querySelector(".target-2 .goal").textContent = `${data.valueTarget.toLocaleString()}회`;
                                document.querySelector(".target-3 .current").textContent = `${data.kcalSum.toLocaleString()}kcal`;
                                document.querySelector(".target-3 .goal").textContent = `${data.kcalTarget.toLocaleString()}kcal`;

                                // ✅ 5. 진행 바 업데이트
                                updateProgress(".target-1 .target-progress", data.exerciseCount, data.exerciseTarget);
                                updateProgress(".target-2 .target-progress", data.valueCount, data.valueTarget);
                                updateProgress(".target-3 .target-progress", data.kcalSum, data.kcalTarget);

                                // ✅ 6. 목표 달성 여부 확인 및 SUCCESS 도장 표시
                                toggleSuccessStamp(".target-1 .success-stamp", data.exerciseCount, data.exerciseTarget);
                                toggleSuccessStamp(".target-2 .success-stamp", data.valueCount, data.valueTarget);
                                toggleSuccessStamp(".target-3 .success-stamp", data.kcalSum, data.kcalTarget);

                                // ✅ 7. 목표가 달성되지 않은 경우 target_count 감소
                                checkAllGoalsCompleted(userPk, data);
                              })
                              .catch(error => console.error("Error loading target data:", error));

                      $("#loading-screen").fadeOut(); // "저장 중" 메시지 및 스피너 제거
                      // ✅ 모달 문구를 원래대로 복원 (필요하다면)
                      $("#loading-screen p").text("이번 주에 기록한 내용을 반영 중 입니다...");

                      alert(result.message); // ✅ 삭제 완료 메시지 출력
                      window.location.reload();
                    }, 2000); // 서버에서 삭제된 데이터를 반영할 시간을 줌
                  })
                  .catch(error => console.error("Delete failed:", error));
        });
      }


        // ✅ 모달 닫기 기능
      function closeModal() {
        document.getElementById("event-modal").style.display = "none";
      }
    </script>
    <script th:inline="javascript">
      // 그래프 저장
      document.addEventListener("DOMContentLoaded", function () {
        const userPk = [[${userPk}]]; // Model에서 가져온 userPk 값
        const saveButton = document.querySelector(".save-button"); // 저장 버튼
        const saveForm = document.getElementById("graph-form");// ✅ 폼 제출 이벤트 리스너 추가

        let hasTodayData = false; // 오늘 데이터가 있는지 여부 확인 변수

        // ✅ 오늘 날짜에 그래프 데이터가 있는지 확인
        fetch(`/graph/has-today-graph?userPk=${userPk}`)
                .then(response => response.json())
                .then(hasData => {
                  console.log("Has Today Graph Data:", hasData); // 디버깅 로그
                  hasTodayData = hasData;
                })
                .catch(error => console.error("Error checking today's graph data:", error));

        // ✅ 그래프 저장 함수
        function graphSaveCheck(event) {
          event.preventDefault(); // 기본 제출 방지

          const bloodSugarInput = document.getElementById("blood_sugar");
          const bloodPressInput = document.getElementById("blood_press");
          const weightInput = document.getElementById("weight");

          const bloodSugar = bloodSugarInput.value.trim();
          const bloodPress = bloodPressInput.value.trim();
          const weight = weightInput.value.trim();

          if (!bloodSugar && !bloodPress && !weight) {
            alert("수치를 한 개 이상 입력해주세요.");
            if (!bloodSugar) bloodSugarInput.focus();
            return;
          }

          const data = {
            userPk: userPk,
            bloodSugar: bloodSugar || null,
            bloodPress: bloodPress || null,
            weight: weight || null
          };

          // 저장할 URL 결정 (오늘 날짜에 기존 수치 데이터가 있으면 update, 없으면 save)
          const url = hasTodayData ? '/graph/updateGraph' : '/graph/saveGraph'

          fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(response => {
            console.log("📡 서버 응답 코드:", response.status);
            return response;
          })
          .then(result => {
            alert(hasTodayData ? "오늘의 수치가 업데이트되었습니다." : "오늘의 수치가 저장되었습니다.");

            // ✅ 입력 필드 초기화
            bloodSugarInput.value = "";
            bloodPressInput.value = "";
            weightInput.value = "";

            // ✅ 페이지 새로고침
            window.location.reload();
          })
          .catch(error => console.error('Error:', error));
        }

        if (saveForm) {
          saveForm.addEventListener("submit", graphSaveCheck);
        }
      });

      // 목표 설정
      document.addEventListener("DOMContentLoaded", function () {
        const userPk = [[${userPk}]]; // Model에서 가져온 userPk 값
        const targetWriteBtn = document.querySelector(".target-write-btn");

        // ✅ 운동 기록 횟수 가져오기
        fetch(`/exercise/count?userPk=${userPk}`)
                .then(response => response.json())
                .then(count => {
                  document.getElementById("exercise-count").textContent = `${count}회`;
                })
                .catch(error => console.error("Error fetching exercise count:", error));

        // ✅ 주간 목표 달성 수 가져오기
        fetch(`/target/count?userPk=${userPk}`)
                .then(response => response.json())
                .then(count => {
                  document.getElementById("weekly-goal-count").textContent = `${count}회`;
                })
                .catch(error => console.error("Error fetching weekly goal count:", error));

        // ✅ 이번 주 목표 데이터 가져오기
        fetch(`/target/current-week?userPk=${userPk}`)
                .then(response => response.json())
                .then(data => {
                  if (!data) return;

                  if (data) {
                    targetWriteBtn.disabled = true;
                  }

                  // ✅ 목표 정보 업데이트
                  document.querySelector(".target-1 .current").textContent = `${data.exerciseCount.toLocaleString()}회`;
                  document.querySelector(".target-1 .goal").textContent = `${data.exerciseTarget.toLocaleString()}회`;
                  document.querySelector(".target-2 .current").textContent = `${data.valueCount.toLocaleString()}회`;
                  document.querySelector(".target-2 .goal").textContent = `${data.valueTarget.toLocaleString()}회`;
                  document.querySelector(".target-3 .current").textContent = `${data.kcalSum.toLocaleString()}kcal`;
                  document.querySelector(".target-3 .goal").textContent = `${data.kcalTarget.toLocaleString()}kcal`;

                  // ✅ 진행 바 업데이트
                  updateProgress(".target-1 .target-progress", data.exerciseCount, data.exerciseTarget);
                  updateProgress(".target-2 .target-progress", data.valueCount, data.valueTarget);
                  updateProgress(".target-3 .target-progress", data.kcalSum, data.kcalTarget);

                  // ✅ 목표 달성 여부 확인 및 SUCCESS 도장 표시
                  toggleSuccessStamp(".target-1 .success-stamp", data.exerciseCount, data.exerciseTarget);
                  toggleSuccessStamp(".target-2 .success-stamp", data.valueCount, data.valueTarget);
                  toggleSuccessStamp(".target-3 .success-stamp", data.kcalSum, data.kcalTarget);

                  // ✅ 모든 목표가 달성되었는지 체크 후 target_count 증가
                  checkAllGoalsCompleted(userPk, data);
                })
                .catch(error => console.error("Error loading target data:", error));

        // ✅ 목표 저장 체크 (목표 입력 후 서버로 전송)
        function targetSaveCheck(event) {
          event.preventDefault(); // 기본 제출 방지

          const exerciseTargetInput = document.querySelector("[name='exercise_target']");
          const valueTargetInput = document.querySelector("[name='value_target']");
          const kcalTargetInput = document.querySelector("[name='kcal_target']");

          const exerciseTarget = exerciseTargetInput.value.trim();
          const valueTarget = valueTargetInput.value.trim();
          const kcalTarget = kcalTargetInput.value.trim();

          // ✅ 최소 하나 이상의 입력값이 필요함
          if (!exerciseTarget && !valueTarget && !kcalTarget) {
            alert("목표를 한 개 이상 입력해주세요.");

            // 비어 있는 첫 번째 입력 필드에 포커스 맞추기
            if (!exerciseTarget) {
              exerciseTargetInput.focus();
            } else if (!valueTarget) {
              valueTargetInput.focus();
            } else {
              kcalTargetInput.focus();
            }
            return;
          }

          // ✅ 목표 데이터 객체 생성
          const data = {
            userPk: userPk,
            exerciseTarget: exerciseTarget || null,
            valueTarget: valueTarget || null,
            kcalTarget: kcalTarget || null
          };

          // ✅ 서버로 목표 저장 요청
          fetch('/target/saveTarget', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          })
          .then(response => response.json())
          .then(result => {

            $("#loading-screen").fadeIn();

            // ✅ 2초 후 "저장 중" 메시지 숨기고 alert 띄우기
            setTimeout(() => {
              $("#loading-screen").fadeOut(); // "저장 중" 메시지 및 스피너 제거
              alert(result.message); // ✅ alert 띄움

              // ✅ 입력 필드 초기화
              exerciseTargetInput.value = "";
              valueTargetInput.value = "";
              kcalTargetInput.value = "";

              window.location.reload();
            }, 5000); // "저장 중" 메시지는 2초간 유지 후 alert 창 띄우기
          })
          .catch(error => console.error('Error:', error));
        }

        // ✅ 폼 제출 이벤트 리스너 추가
        const targetForm = document.getElementById("target-form");
        if (targetForm) {
          targetForm.addEventListener("submit", targetSaveCheck);
        }
      });

      // ✅ 목표 진행 바 업데이트 함수
      function updateProgress(selector, current, goal) {
        const progressBar = document.querySelector(selector);
        if (!progressBar) return;

        const percentage = goal === 0 ? 0 : (current / goal) * 100;
        progressBar.style.width = `${percentage}%`;
      }

      // ✅ 목표 달성 여부 확인 및 SUCCESS 도장 표시 함수
      function toggleSuccessStamp(selector, current, target) {
        const stamp = document.querySelector(selector);
        if (stamp) {
          if (target === 0) {
            stamp.style.display = "none"; // 목표 값이 0이면 도장 숨김
          } else {
            stamp.style.display = current >= target ? "flex" : "none"; // 목표 달성 여부에 따라 표시
          }
        }
      }

      // ✅ 목표 달성 여부를 체크하고 `target_count` 업데이트
      function checkAllGoalsCompleted(userPk, data) {
        const exerciseCompleted = data.exerciseCount >= data.exerciseTarget && data.exerciseTarget > 0;
        const valueCompleted = data.valueCount >= data.valueTarget && data.valueTarget > 0;
        const kcalCompleted = data.kcalSum >= data.kcalTarget && data.kcalTarget > 0;

        const allGoalsCompleted = exerciseCompleted && valueCompleted && kcalCompleted;

        // ✅ 현재 목표 달성 개수 가져오기 (디버깅 추가)
        fetch(`/target/count?userPk=${userPk}`)
                .then(response => response.json())
                .then(count => {
                  const currentTargetCount = count;
                  // console.log("현재 target_count:", currentTargetCount);
                  // console.log("현재 목표 달성 상태:", allGoalsCompleted);

                  if (allGoalsCompleted && currentTargetCount === 0) {
                    // console.log("✅ 목표를 처음 달성했으므로 증가!");
                    updateTargetCount(userPk, "increase");
                  } else if (!allGoalsCompleted && currentTargetCount > 0) {
                    // console.log("⛔️ 목표가 달성되지 않았으므로 감소!");
                    updateTargetCount(userPk, "decrease");
                  } else {
                    // console.log("🔄 목표 상태가 변하지 않으므로 업데이트 없음.");
                  }
                })
                .catch(error => console.error("Error fetching weekly goal count:", error));
      }

      // ✅ 목표 달성 시 user_detail 테이블의 target_count +1 업데이트 (이번 주에 한 번만)
      function updateTargetCount(userPk, action) {
        console.log(`🚀 updateTargetCount 실행됨! Action: ${action}`); // 디버깅 추가

        fetch(`/target/update-target-count?userPk=${userPk}&action=${action}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userPk }),
        })
                .then(response => response.json())
                .then(result => {
                  console.log(`✅ Target count ${action} 성공:`, result);
                  // ✅ 주간 목표 달성 수 가져오기
                  fetch(`/target/count?userPk=${userPk}`)
                          .then(response => response.json())
                          .then(count => {
                            document.getElementById("weekly-goal-count").textContent = `${count}회`;
                            console.log(`🎯 UI 업데이트 완료: ${count}회`);
                          })
                          .catch(error => console.error("Error fetching weekly goal count:", error));
                })
                .catch(error => console.error(`❌ Target count ${action} 실패:`, error));
      }

    </script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<!-- 목표 저장 로딩 모달 -->
<div id="loading-screen" style="display: none;">
    <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
      <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
    </svg>
    <p>이번 주에 기록한 내용을 반영 중 입니다...</p>
  </div>
</div>

<!-- ✅ 이벤트 클릭 시 표시할 모달 -->
<div id="event-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h2 id="modal-title"></h2>
    <p id="modal-content"></p>
    <button class="exercise-delete-btn">기록 삭제</button>
  </div>
</div>

<!-- ✅ 목표 작성 버튼 클릭 시 표시할 모달 -->
<div class="target-popup">
  <div class="target-popup-content">
    <div class="target-popup__head">
      <div>주간 목표 설정하기 <i class="fa-solid fa-trophy"></i></div>
      <button class="target-popup-close-btn">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="target-popup__body">
      <form id="target-form">
        <ul>
          <li>
            이번 주 운동 횟수 목표 :
            <input type="number" name="exercise_target" min="0" step="1"> 회
          </li>
          <li>
            이번 주 수치 기록 횟수 목표 :
            <input type="number" name="value_target" min="0" step="1"> 회
          </li>
          <li>
            이번 주 소모 칼로리 목표 :
            <input type="number" name="kcal_target" min="0" step="1"> kcal
          </li>
        </ul>
        <button type="submit" class="target-save-btn">저 장</button>
      </form>
    </div>
  </div>
</div>

<!-- ✅ 운동명 더보기 버튼 클릭 시 표시할 모달 -->
<div class="exercise-type-popup">
  <div class="exercise-type-popup-content">
    <div class="exercise-type-popup__head">
      <div>
        <input id="exercise-search" type="text" placeholder="종목 이름을 검색하세요">
        <button class="search-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
      </div>
      <button class="exercise-type-popup-close-btn">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="exercise-type-popup__body"></div>
    <div class="exercise-type-popup__foot">
      <button type="button" class="exercise-type-save-btn">저 장</button>
    </div>
  </div>
</div>

<!-- 메인 -->
<section class="main">

  <div class="top-service">
    <div class="left-service">
      <h2>주간 목표 <i class="fa-solid fa-trophy"></i></h2>
      <div class="target-box">
        <div class="target-1">
          <div><span>이번 주 운동 횟수</span></div>
          <div>
            <div class="target-values">
              <span class="current">0회</span>
              <span class="goal">0회</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
              <div class="success-stamp">SUCCESS</div> <!-- ✅ 도장 효과 추가 -->
            </div>
          </div>
        </div>
        <div class="target-2">
          <div><span>이번 주 수치 기록 횟수</span></div>
          <div>
            <div class="target-values">
              <span class="current">0회</span>
              <span class="goal">0회</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
              <div class="success-stamp">SUCCESS</div> <!-- ✅ 도장 효과 추가 -->
            </div>
          </div>
        </div>
        <div class="target-3">
          <div><span>이번 주 칼로리 소모량</span></div>
          <div>
            <div class="target-values">
              <span class="current">0kcal</span>
              <span class="goal">0kcal</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
              <div class="success-stamp">SUCCESS</div> <!-- ✅ 도장 효과 추가 -->
            </div>
          </div>
        </div>
        <button type="button" class="target-write-btn">목표 작성</button>
      </div>
    </div>
    <div class="right-service">
      <h2>오늘의 수치 기록하기 <i class="fa-solid fa-pencil"></i></h2>
      <div class="graph">
        <form name="graph-frm" id="graph-form">
          <ul>
            <li>혈당 <input type="number" id="blood_sugar" name="blood_sugar" required> mg/dL</li>
            <li>혈압 <input type="number" id="blood_press" name="blood_press" required> mmHg</li>
            <li>몸무게 <input type="number" id="weight" name="weight" class="weight" required> kg</li>
          </ul>
          <button type="submit" class="save-button">저 장</button>
        </form>
      </div>
      <div class="cumulative-count">
        <div class="cumulative-title">
          <span>내가 달성한 주간 목표 수 <i class="fa-solid fa-medal"></i> </span>
          <span>내가 운동 기록한 횟수 <i class="fa-solid fa-medal"></i> </span>
        </div>
        <div class="cumulative-total">
          <span id="weekly-goal-count">0회</span>
          <span id="exercise-count">0회</span>
        </div>
      </div>
    </div>
  </div>

  <div class="exercise-entry">
    <form>
      <div class="exercise-type">
        운동 종류 :
        <span id="selected-exercise"></span>
        <i class="exercise-type-popup-btn fa-solid fa-plus"></i>
        <button id="reset-exercise-btn" type="button" style="/*display: none;*/"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <input type="hidden" id="selected-exercise-name" name="exerciseName">
      <input type="hidden" id="selected-exercise-met" name="met">

      <div class="exercise-time">
        <input type="hidden" id="selected-date" name="selectdate">
        운동 시간 :
        <select id="hour" name="hour">
          <option value="00" selected>0시간</option>
          <option value="01">1시간</option>
          <option value="02">2시간</option>
          <option value="03">3시간</option>
          <option value="04">4시간</option>
          <option value="05">5시간</option>
        </select> :
        <select id="minute" name="minute">
          <option value="00" selected>0분</option>
          <option value="15">15분</option>
          <option value="30">30분</option>
          <option value="45">45분</option>
        </select>
      </div>
      <button type="submit" class="exercise-save">저 장</button>
    </form>
  </div>

  <div class="calendar" id="calendar"></div>

</section>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

</body>
</html>