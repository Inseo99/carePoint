<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>운동 페이지</title>
    <link href="/css/exercise/exerciseMain.css" rel="stylesheet">
    <!-- 제이쿼리 불러오기 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
      // 버튼 클릭 하면 팝업 보여줌
      $('.target-write-btn').click(function () {
        console.log("target-write-btn 들어옴");
        $('.target-popup').css('display', 'flex');
      });

      // 버튼 클릭 하면 팝업 가림
      $('.target-popup-close-btn').click(function () {
        $('.target-popup').css('display', 'none');
      });

      // .popup을 클릭하면 닫히도록 설정
      $(".target-popup").on("click", function () {
        $(this).hide(); // .popup을 숨김
      });

      // .popup-content 내부를 클릭했을 때 이벤트 전파 방지
      $(".target-popup-content").on("click", function (event) {
        event.stopPropagation(); // 부모(.popup)로 이벤트가 전달되지 않도록 방지
      });

      // 버튼 클릭 하면 팝업 보여줌
      $('.exercise-type-popup-btn').click(function () {
        $('.exercise-type-popup').css('display', 'flex');
      });

      // 버튼 클릭 하면 팝업 가림
      $('.exercise-type-popup-close-btn').click(function () {
        $('.exercise-type-popup').css('display', 'none');
      });

      // .popup을 클릭하면 닫히도록 설정
      $(".exercise-type-popup").on("click", function () {
        $(this).hide(); // .popup을 숨김
      });

      // .popup-content 내부를 클릭했을 때 이벤트 전파 방지
      $(".exercise-type-popup-content").on("click", function (event) {
        event.stopPropagation(); // 부모(.popup)로 이벤트가 전달되지 않도록 방지
      });

    });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridWeek', // 주 단위로 표시
          height: 'auto',
          headerToolbar: {
            left: 'prev',
            center: 'title',
            right: 'next'
          },
          views: {
            dayGridMonth: {
              titleFormat: { year: 'numeric', month: '2-digit' } // YYYY.MM 형식
            },
            dayGridWeek: {
              titleFormat: { year: 'numeric', month: '2-digit'} // YYYY.MM.DD 형식
            }
          },
          dayCellDidMount: function(info) {
            let cell = info.el;
            let existingDateEl = cell.querySelector('.fc-daygrid-day-number');

            if (existingDateEl) {
              existingDateEl.remove(); // 기존 날짜 삭제
            }

            let dateEl = document.createElement('div');
            dateEl.classList.add('fc-daygrid-day-number');
            dateEl.innerText = info.date.getDate();

            dateEl.style.position = 'absolute';
            dateEl.style.top = '8px';
            dateEl.style.right = '8px';
            dateEl.style.fontSize = '14px';
            dateEl.style.fontWeight = 'bold';
            dateEl.style.zIndex = '10';

            // 요일에 따라 색상 변경 (일요일: 빨강, 토요일: 파랑)
            let dayOfWeek = info.date.getDay(); // 0: 일요일, 6: 토요일
            if (dayOfWeek === 0) {
              dateEl.style.color = 'red';
            } else if (dayOfWeek === 6) {
              dateEl.style.color = 'blue';
            } else {
              dateEl.style.color = 'black';
            }

            cell.appendChild(dateEl);
          },
          dayHeaderFormat: { weekday: 'short' }, // 요일만 표시
          datesSet: function(info) {
            // FullCalendar가 계산한 타이틀 문자열
            const rawTitle = info.view.title; // 예: "2025/02"

            // 여기서 직접 split 처리
            const parts = rawTitle.split('/');
            let year = 'Unknown Year';
            let month = 'Unknown Month';

            if (parts.length === 2) {
              year = parts[1].trim();
              month = parts[0].trim();
            }

            // 그다음 DOM 조작 (titleEl 제거/추가 등)
            const titleEl = document.querySelector('.fc-toolbar-title');
            if (titleEl) {
                        titleEl.innerHTML = `
                            <div class="calendar-title">
                              <div class="calendar-year">${year}</div>
                              <div class="calendar-month">${month}</div>
                            </div>
                          `;
            }
            setTimeout(() => {
              document.querySelectorAll('.fc-daygrid-day').forEach(cell => {
                let existingDateEl = cell.querySelector('.fc-daygrid-day-number');

                // 기존 날짜 요소가 있으면 삭제
                if (existingDateEl) {
                  existingDateEl.remove();
                }

                // 새로운 날짜 요소 생성
                let dateEl = document.createElement('div');
                dateEl.classList.add('fc-daygrid-day-number');

                // 날짜 계산
                let date = new Date(cell.getAttribute('data-date')).getDate();
                dateEl.innerText = date;

                // 날짜 스타일 적용
                dateEl.style.position = 'absolute';
                dateEl.style.top = '8px';
                dateEl.style.right = '8px';
                dateEl.style.fontSize = '14px';
                dateEl.style.color = 'black';
                dateEl.style.fontWeight = 'bold';
                dateEl.style.zIndex = '10';

                // 날짜 요소 추가
                cell.appendChild(dateEl);
              });
            }, 50);
            adjustRowHeights();
          },
          events: [
            {
              title: '운동 종목: 줄넘기<br>운동 시간: 1시간<br>총 소모 칼로리: <b class="highlight-kcal">742</b>kcal',
              start: '2025-02-05',
              extendedProps: {
                icon: '/images/운동일러.jpg',
              }
            },
            {
              title: '운동 종목: 줄넘기<br>운동 시간: 1시간<br>총 소모 칼로리: <b class="highlight-kcal">742</b>kcal',
              start: '2025-02-07',
              extendedProps: {
                icon: '/images/운동일러.jpg',
              }
            }
          ],
          eventContent: function(info) {
            let iconUrl = info.event.extendedProps.icon;
            return {
              html: `<div class="custom-event">
                        <div class="event-top">
                            <img src="${iconUrl}" alt="운동 아이콘" class="event-icon">
                        </div>
                        <div class="event-text">${info.event.title}</div>
                     </div>`
            };
          }
        });
        calendar.render();

        function adjustRowHeights() {
          requestAnimationFrame(() => {
            document.querySelectorAll('.fc-daygrid-body tr').forEach(row => {
              let hasEvent = row.querySelector('.fc-daygrid-event'); // 해당 주에 이벤트가 있는지 확인

              let targetHeight = hasEvent ? 210 : 150;
              let currentHeight = parseInt(window.getComputedStyle(row).height, 10);

              if (currentHeight !== targetHeight) {
                row.style.transition = 'height 0.3s ease-in-out';
                row.style.overflow = 'hidden';
                row.style.height = `${targetHeight}px`;
              }
            });
          });
        }
      });
    </script>
    <script>
      function saveCheck() {
        // 입력 필드 가져오기
        const bloodSugarInput = document.getElementById("blood_sugar");
        const bloodPressInput = document.getElementById("blood_press");
        const weightInput = document.getElementById("weight");

        // 입력 값 가져오기
        const bloodSugar = bloodSugarInput.value.trim();
        const bloodPress = bloodPressInput.value.trim();
        const weight = weightInput.value.trim();

        // 최소 하나 이상의 입력값이 필요함
        if (!bloodSugar && !bloodPress && !weight) {
          alert("수치를 한 개 이상 입력해주세요.");

          // 비어 있는 첫 번째 입력 필드에 포커스 맞추기
          if (!bloodSugar) {
            bloodSugarInput.focus();
          }

          return; // 서버로 요청 보내지 않음
        }

        // 데이터 객체 생성
        const data = {
          bloodSugar: bloodSugar || null, // 값이 비어있으면 null로 전달
          bloodPress: bloodPress || null,
          weight: weight || null
        };

        // 서버로 데이터 전송
        fetch('/exercise/saveGraph', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.text())
        .then(result => {
          alert(result); // 저장 성공 메시지

          // ✅ 입력 필드 초기화 (값을 비움)
          bloodSugarInput.value = "";
          bloodPressInput.value = "";
          weightInput.value = "";

          // ✅ 첫 번째 입력 필드에 포커스 맞추기
          bloodSugarInput.focus();
        })
        .catch(error => console.error('Error:', error));
      }
    </script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div class="target-popup">
  <div class="target-popup-content">
    <div class="target-popup__head">
      <div>주간 목표 설정하기 <i class="fa-solid fa-trophy"></i></div>
      <button class="target-popup-close-btn">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="target-popup__body">
      <ul>
        <li>이번 주 운동 횟수 목표 : <input type="number" min="0" step="1"> 회</li>
        <li>이번 주 수치 기록 횟수 목표 : <input type="number" min="0" step="1"> 회</li>
        <li>이번 주 소모 칼로리 목표 : <input type="number" min="0" step="1"> kcal</li>
      </ul>
      <button type="button" class="target-save-btn">저 장</button>
    </div>
  </div>
</div>
<div class="exercise-type-popup">
  <div class="exercise-type-popup-content">
    <div class="exercise-type-popup__head">
      <div>
        <input type="text" placeholder="종목 이름을 검색하세요">
        <button class="search-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
      </div>
      <button class="exercise-type-popup-close-btn">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="exercise-type-popup__body">
      <div class="exercise-container">
        <div>
          <div><img src="/images/줄넘기.jpg" alt="줄넘기"></div>
          <div>줄넘기</div>
        </div>
        <div>
          <div><img src="/images/체조.jpg" alt="체조"></div>
          <div>체조</div>
        </div>
        <div>
          <div><img src="/images/농구.jpg" alt="농구"></div>
          <div>농구</div>
        </div>
        <div>
          <div><img src="/images/자전거.jpg" alt="자전거"></div>
          <div>자전거</div>
        </div>
        <div>
          <div><img src="/images/데드리프트.jpg" alt="데드리프트"></div>
          <div>데드리프트</div>
        </div>
        <div>
          <div><img src="/images/사이클.jpg" alt="사이클"></div>
          <div>사이클</div>
        </div>
      </div>
      <button type="button" class="exercise-type-save-btn">저 장</button>
    </div>
  </div>
</div>

<section class="main">

  <div class="top-service">
    <div class="left-service">
      <h2>주간 목표 <i class="fa-solid fa-trophy"></i></h2>
      <div class="target-box">
        <div class="target-1">
          <div><span>이번 주 운동 횟수</span></div>
          <div>
            <div class="target-values">
              <span class="current">1회</span>
              <span class="goal">3회</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
            </div>
          </div>
        </div>
        <div class="target-2">
          <div><span>이번 주 수치 기록 횟수</span></div>
          <div>
            <div class="target-values">
              <span class="current">1회</span>
              <span class="goal">3회</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
            </div>
          </div>
        </div>
        <div class="target-3">
          <div><span>이번 주 칼로리 소모량</span></div>
          <div>
            <div class="target-values">
              <span class="current">742kcal</span>
              <span class="goal">2,000kcal</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
            </div>
          </div>
        </div>
        <button type="button" class="target-write-btn">목표 작성</button>
      </div>
    </div>
    <div class="right-service">
      <h2>오늘의 수치 기록하기 <i class="fa-solid fa-pencil"></i></h2>
      <div class="graph">
        <form name="graph-frm">
          <ul>
            <li>혈당 <input type="text" id="blood_sugar" name="blood_sugar" required> mg/dL</li>
            <li>혈압 <input type="text" id="blood_press" name="blood_press" required> mmHg</li>
            <li>몸무게 <input type="text" id="weight" name="weight" class="weight" required> kg</li>
          </ul>
          <button type="button" class="save-button" onclick="saveCheck()">저 장</button>
        </form>
      </div>
      <div class="cumulative-count">
        <div class="cumulative-title">
          <span>내가 달성한 주간 목표 수 <i class="fa-solid fa-medal"></i> </span>
          <span>내가 운동 기록한 횟수 <i class="fa-solid fa-medal"></i> </span>
        </div>
        <div class="cumulative-total">
          <span>32회</span>
          <span>151회</span>
        </div>
      </div>
    </div>
  </div>

  <div class="exercise-entry">
    <form>
      <div class="exercise-type">
        운동 종류 : <i class="exercise-type-popup-btn fa-solid fa-plus"></i>
      </div>
      <div class="exercise-time">
        <input type="hidden" id="selected-date" name="selectdate">
        운동 시간 :
        <select id="hour" name="hour">
          <option value="00" selected>0시간</option>
          <option value="01">1시간</option>
          <option value="02">2시간</option>
          <option value="03">3시간</option>
          <option value="04">4시간</option>
          <option value="05">5시간</option>
        </select> :
        <select id="minute" name="minute">
          <option value="00" selected>0분</option>
          <option value="15">15분</option>
          <option value="30">30분</option>
          <option value="45">45분</option>
        </select>
      </div>
      <button type="submit">저 장</button>
    </form>
  </div>

  <div class="calendar" id="calendar"></div>
</section>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

</body>
</html>