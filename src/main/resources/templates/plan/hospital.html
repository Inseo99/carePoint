<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가까운 병원 찾기</title>
    <link href="/css/plan/hospital.css" type="text/css" rel="stylesheet">
</head>
<body>
<!--header-->
<div th:insert="~{/common/header.html}"></div>

<section class="main">
    <div class="search">
        <div class="search-head">
            <div class="search-title">
                내 주변 병원
            </div>
            <div class="search-form">
                <form action="">
                    <label>
                        <input type="text" placeholder="장소 검색하기">
                    </label>
                    <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
                </form>
            </div>
        </div>
        <div class="search-list">
        </div>
    </div>
    <div id="map"></div>
</section>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
    let map;
    let service;
    let infowindow;

    // 지도 불러오기
    function initMap() {
        // 기본 센터를 LatLng 객체로 생성
        const center = new google.maps.LatLng(37.5665, 126.9780);
        map = new google.maps.Map(document.getElementById("map"), {
            center: center,
            zoom: 15
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    // 사용자 위치를 LatLng 객체로 생성
                    const userLatLng = new google.maps.LatLng(
                        position.coords.latitude,
                        position.coords.longitude
                    );

                    map.setCenter(userLatLng);

                    // 사용자 위치에 기본 Marker 추가
                    new google.maps.Marker({
                        position: userLatLng,
                        map: map,
                        title: "내 위치"
                    });

                    findNearbyHospitals(userLatLng);
                },
                error => {
                    console.error("위치 정보를 가져올 수" +
                        "니다.", error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            alert("위치 정보를 사용할 수 없습니다.");
        }
    }

    // 병원찾기 함수
    function findNearbyHospitals(location) {
        const request = {
            location: location,
            radius: 5000,
            type: "hospital"
        };

        service = new google.maps.places.PlacesService(map);
        service.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                for (let i = 0; i < results.length; i++) {
                    const place = results[i];
                    if (!place.geometry || !place.geometry.location) continue;

                    // 병원 위치에 기본 Marker 추가
                    const marker = new google.maps.Marker({
                        position: place.geometry.location,
                        map: map,
                        title: place.name,
                        icon: {
                            url: "/images/hospital.png",  // 이미지 파일의 상대 경로
                            scaledSize: new google.maps.Size(40, 40), // 아이콘 크기 조절
                            origin: new google.maps.Point(0, 0),        // 이미지 시작 좌표
                            anchor: new google.maps.Point(20, 40)         // 아이콘 표시 기준점
                        }
                    });

                    // 병원리스트띄우기
                    getPlaceDetails(place.place_id, details => {
                        let contentHTML = `<strong>${details ? details.name : place.name}</strong><br>`;
                        contentHTML += `${details ? details.adr_address : place.vicinity}`;

                        const listContainer =  document.querySelector('.search-list');

                        if (details && details.formatted_phone_number) {
                            contentHTML += `<br>전화번호: ${details.formatted_phone_number}`;
                        }

                        const listItem = document.createElement('div');
                        listItem.classList.add('list-item');
                        listItem.innerHTML = contentHTML;
                        listContainer.appendChild(listItem);
                    });

                    marker.addListener("click", () => {
                        infowindow = new google.maps.InfoWindow({
                            content: `<div><strong>${place.name}</strong><br>${place.vicinity}</div>`,
                        });
                        infowindow.open(map, marker);
                    });
                }
            } else {
                console.error("Places API 오류:", status);
            }
        });
    }

    // 병원 정보가져오기
    function getPlaceDetails(placeId, callback) {
        const request = {
            placeId: placeId,
            fields: ['name', 'adr_address', 'formatted_phone_number', 'business_status']
        }

        service.getDetails(request, (placeDetails, status) => {
           if(status === google.maps.places.PlacesServiceStatus.OK) {
               callback(placeDetails);
           }else {
               console.error('Place details 요청 오류:', status);
               callback(null);
           }
        });
    }

</script>
<!-- 안정화(stable) 버전의 API 스크립트 로드 -->
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB8Lr0W0_S0gchFmLITwOCGGDrjiZCav1E&libraries=places&callback=initMap">
</script>

</body>
</html>